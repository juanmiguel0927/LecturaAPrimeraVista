<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Lectura a Primera Vista</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css?family=Inter:wght@400;600;700;800&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #111827; }
        #loading-message { position: fixed; top: 50%; left: 50%; transform: translate(-50%,-50%); z-index: 1000; background-color: #1f2937; color: white; padding: 2rem; border-radius: 0.75rem; font-size: 1.5rem; font-weight: bold; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.7); display: flex; justify-content: center; align-items: center; z-index: 100; }
        .modal-content { background-color: #374151; color: #d1d5db; padding: 2rem; border-radius: 1rem; max-width: 90%; width: 500px; max-height: 90%; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 1rem; right: 1rem; font-size: 1.5rem; cursor: pointer; }
        .stave-container { position: relative; }
        .tutorial-highlight-overlay { position: fixed; top: 0; left: 0; pointer-events: none; z-index: 99; transition: all 0.5s ease-in-out; box-shadow: 0 0 0 0 transparent; border-radius: 1rem; }
        .pre-roll-message { position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 10; display: flex; align-items: center; justify-content: center; flex-direction: column; color: #34d399; font-size: 3rem; font-weight: 800; text-shadow: 0 2px 4px rgba(0,0,0,0.2); }
        .pre-roll-message-count { font-size: 5rem; }
        .tutorial-step.active { color: #34d399; font-weight: bold; }
        .radio-label { display: inline-block; background-color: #4b5563; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; transition: all 0.2s ease-in-out; border: 2px solid transparent; }
        input[type="radio"]:checked + .radio-label { background-color: #374151; color: #34d399; border-color: #34d399; }
    </style>
</head>
<body class="bg-zinc-900 text-white flex flex-col items-center p-4 min-h-screen">
    <div id="loading-message">Cargando...</div>
    <div id="main-content" class="hidden bg-zinc-800 rounded-2xl text-center border-2 shadow-2xl p-6 md:p-10 w-full max-w-4xl border-emerald-500">
        <h1 class="text-4xl md:text-5xl font-extrabold text-emerald-400 mb-2 drop-shadow-md">Lectura a Primera Vista</h1>
        <p class="text-zinc-500 text-sm mb-4">Aplicación realizada por Juan Miguel Rios Redondo</p>
        <p class="text-zinc-400 text-lg md:text-xl mb-6">Ejercicios para guitarra</p>
        <div id="exercise-type-control" class="flex items-center justify-center space-x-2 mb-6">
            <span class="text-zinc-300 font-bold mr-2">Tipo de Ejercicio:</span>
            <div>
                <input type="radio" name="exerciseType" id="type-melodia" value="melodia" class="hidden" checked>
                <label for="type-melodia" class="radio-label">Melodía</label>
            </div>
            <div>
                <input type="radio" name="exerciseType" id="type-armonia" value="armonia" class="hidden">
                <label for="type-armonia" class="radio-label">Armonía</label>
            </div>
        </div>
        <div id="controls-container" class="flex flex-wrap items-center justify-center gap-4 mb-8">
            <div id="harmony-options-container" class="hidden flex items-center space-x-2">
                <label for="notes-per-chord" class="text-zinc-300">Notas:</label>
                <select id="notes-per-chord" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="2">2</option><option value="3" selected>3</option><option value="4">4</option>
                </select>
            </div>
            <div id="interval-options-container" class="hidden flex items-center space-x-2">
                <label for="interval-select" class="text-zinc-300">Intervalo:</label>
                <select id="interval-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="0" selected>Todos</option>
                    <option value="1">2da</option><option value="2">3ra</option><option value="3">4ta</option>
                    <option value="4">5ta</option><option value="5">6ta</option><option value="6">7ma</option><option value="7">8va</option>
                </select>
            </div>
            <div id="triad-options-container" class="hidden flex items-center space-x-2">
                <label for="triad-select" class="text-zinc-300">Tipo de Acorde:</label>
                <select id="triad-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="all" selected>Todos</option>
                    <option value="triad_fundamental">Tríada Fundamental</option>
                    <option value="triad_inv1">Tríada 1ra Inv.</option>
                    <option value="triad_inv2">Tríada 2da Inv.</option>
                    <option value="sus2_all">Acordes Sus2</option>
                    <option value="sus4_all">Acordes Sus4</option>
                </select>
            </div>
             <div id="quad-options-container" class="hidden flex flex-wrap items-center justify-center gap-4">
                <div id="quad-voicing-container" class="flex items-center space-x-2">
                    <label for="quad-voicing-select" class="text-zinc-300">Voicing:</label>
                    <select id="quad-voicing-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                        {/* Options will be populated by JS */}
                    </select>
                </div>
            </div>
            <div class="flex items-center space-x-2">
                <label for="tempo" class="text-zinc-300">Tempo (BPM):</label>
                <input type="number" id="tempo" value="60" min="1" class="w-20 p-2 text-center rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
            </div>
            <div class="flex items-center space-x-2">
                <label for="clef-select" class="text-zinc-300">Clave:</label>
                <select id="clef-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="G" selected>Sol</option><option value="F">Fa</option><option value="C">Do</option>
                </select>
            </div>
             <div class="flex items-center space-x-2">
                <label for="key-signature-select" class="text-zinc-300">Armadura:</label>
                <select id="key-signature-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="C">Do M / La m (0)</option>
                    <optgroup label="Sostenidos">
                        <option value="G">Sol M / Mi m (1♯)</option>
                        <option value="D">Re M / Si m (2♯)</option>
                        <option value="A">La M / Fa♯ m (3♯)</option>
                        <option value="E">Mi M / Do♯ m (4♯)</option>
                        <option value="B">Si M / Sol♯ m (5♯)</option>
                        <option value="F#">Fa♯ M / Re♯ m (6♯)</option>
                        <option value="C#">Do♯ M / La♯ m (7♯)</option>
                    </optgroup>
                    <optgroup label="Bemoles">
                        <option value="F">Fa M / Re m (1♭)</option>
                        <option value="Bb">Si♭ M / Sol m (2♭)</option>
                        <option value="Eb">Mi♭ M / Do m (3♭)</option>
                        <option value="Ab">La♭ M / Fa m (4♭)</option>
                        <option value="Db">Re♭ M / Si♭ m (5♭)</option>
                        <option value="Gb">Sol♭ M / Mi♭ m (6♭)</option>
                        <option value="Cb">Do♭ M / La♭ m (7♭)</option>
                    </optgroup>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="time-signature-select" class="text-zinc-300">Compás:</label>
                <select id="time-signature-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="4/4">4/4</option><option value="3/4">3/4</option><option value="2/4">2/4</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="difficulty-select" class="text-zinc-300">Nivel:</label>
                <select id="difficulty-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="basico">Básico</option><option value="medium">Medio</option><option value="advanced">Avanzado</option>
                </select>
            </div>
            <div class="flex items-center space-x-2">
                <label for="measures-select" class="text-zinc-300">Compases:</label>
                <select id="measures-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
                    <option value="5">5</option><option value="10" selected>10</option><option value="15">15</option><option value="20">20</option><option value="custom">Personalizado</option>
                </select>
            </div>
             <div id="custom-measures-input-container" class="hidden flex items-center space-x-2">
                <label for="custom-measures-input" class="text-zinc-300">Nº:</label>
                <input type="number" id="custom-measures-input" value="10" placeholder="Nº" min="1" class="w-20 p-2 text-center rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500"/>
            </div>
            <div class="flex items-center space-x-2">
                <label for="show-note-names" class="text-zinc-300">Nombres:</label>
                <input type="checkbox" id="show-note-names" class="w-5 h-5 rounded bg-zinc-700 text-emerald-500 border-zinc-600 focus:ring-emerald-500 focus:ring-2"/>
            </div>
        </div>
        <div id="change-beat-control" class="flex items-center justify-center space-x-2 mb-8">
            <label for="change-beat-select" class="text-zinc-300">Cambiar compás en tiempo:</label>
            <select id="change-beat-select" class="p-2 rounded-lg bg-zinc-700 text-white border border-zinc-600 focus:outline-none focus:ring-2 focus:ring-emerald-500">
            </select>
        </div>
        <div class="flex justify-center space-x-4 mb-8">
            <button id="startStopButton" class="bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">Comenzar</button>
            <button id="pauseResumeButton" class="hidden bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">Pausar</button>
            <button id="show-tutorial" class="bg-gray-600 hover:bg-gray-500 text-white font-bold py-3 px-6 rounded-full shadow-lg transform hover:scale-105 transition-all duration-300">Tutorial</button>
        </div>
        <div class="bg-zinc-700 p-2 md:p-6 rounded-lg shadow-inner mb-8 overflow-x-auto w-full">
            <div id="stave-container" class="stave-container w-full h-80 flex items-center justify-center bg-white rounded-lg shadow-md border border-zinc-600"></div>
        </div>
        <div id="displayArea" class="hidden bg-zinc-700 p-6 rounded-lg shadow-inner">
            <div class="flex justify-center items-center space-x-4">
                <span class="text-zinc-300 font-mono">Tiempo: <span id="metronomeCount" class="text-2xl font-bold ml-2 text-zinc-400">0</span></span>
                <span class="text-zinc-300 font-mono">Compases: <span id="measuresCount" class="text-xl font-bold text-sky-400">0 / 10</span></span>
            </div>
        </div>
        <div id="pre-roll-message" class="pre-roll-message hidden">
            <span>Preparación</span><span id="preRollCount" class="pre-roll-message-count"></span>
        </div>
    </div>
    <div id="tutorial-modal" class="modal-overlay hidden">
        <div class="modal-content text-left">
            <span class="modal-close" id="close-modal">×</span>
            <h2 class="text-2xl sm:text-3xl font-bold mb-4 text-emerald-400">Tutorial</h2>
            <div id="tutorial-steps-container"></div>
            <button id="next-tutorial-step" class="mt-4 bg-emerald-500 hover:bg-emerald-600 text-white font-bold py-2 px-4 rounded-full shadow-lg">Siguiente</button>
        </div>
    </div>
    <div id="tutorial-highlight-overlay" class="tutorial-highlight-overlay hidden"></div>
    <script>
        // --- GLOBAL SCOPE ---
        let ui, state, audio, notesData;
        // --- INITIALIZATION ---
        window.onload = () => {
            try {
                initializeElements();
                initializeAppState();
                attachEventListeners();
                updateChangeBeatOptions();
                updateDropVoicingOptions();
                updateHarmonyControlsVisibility();
                renderStave();
                ui.loadingMessage.style.display = 'none';
                ui.mainContent.classList.remove('hidden');
            } catch (e) {
                console.error('Fatal error during initialization:', e);
                document.getElementById('loading-message').textContent = "Error al cargar. Refresca la página.";
            }
        };
                function initializeElements() {
            const get = (id) => { const el = document.getElementById(id); if (!el) throw new Error(`Element "${id}" not found.`); return el; };
            ui = {
                loadingMessage: get('loading-message'), mainContent: get('main-content'), startStopButton: get('startStopButton'),
                pauseResumeButton: get('pauseResumeButton'),
                displayArea: get('displayArea'), tempoInput: get('tempo'), metronomeCount: get('metronomeCount'),
                staveContainer: get('stave-container'), clefSelect: get('clef-select'), timeSigSelect: get('time-signature-select'),
                measuresSelect: get('measures-select'), measuresCount: get('measuresCount'), customMeasuresContainer: get('custom-measures-input-container'),
                customMeasuresInput: get('custom-measures-input'), preRollMessage: get('pre-roll-message'), difficultySelect: get('difficulty-select'),
                changeBeatSelect: get('change-beat-select'), showTutorialBtn: get('show-tutorial'), tutorialModal: get('tutorial-modal'),
                closeModalBtn: get('close-modal'), tutorialStepsContainer: get('tutorial-steps-container'), nextTutorialStepBtn: get('next-tutorial-step'),
                tutorialHighlight: get('tutorial-highlight-overlay'), preRollCount: get('preRollCount'), showNoteNamesToggle: get('show-note-names'),
                exerciseTypeRadios: document.querySelectorAll('input[name="exerciseType"]'), harmonyOptionsContainer: get('harmony-options-container'),
                notesPerChordSelect: get('notes-per-chord'), changeBeatContainer: get('change-beat-control'), intervalOptionsContainer: get('interval-options-container'),
                intervalSelect: get('interval-select'), triadOptionsContainer: get('triad-options-container'), triadSelect: get('triad-select'),
                quadOptionsContainer: get('quad-options-container'), quadVoicingSelect: get('quad-voicing-select'),
                keySigSelect: get('key-signature-select')
            };
        }
        function initializeAppState() {
            state = { 
                exerciseType: 'melodia', notesPerChord: 3, selectedInterval: 0, selectedTriad: 'all',
                selectedQuadVoicing: 'drop2',
                exerciseStarted: false, isPaused: false, metronomeTimer: null, exerciseMeasures: [], currentMeasureContent: [], 
                currentMetronomeCount: 0, timeSignatureBeats: 4, measuresChangeBeat: 4, currentMeasureIndex: -1, 
                measuresPerExercise: 10, isPreRoll: false, isPlaying: false, showNoteNames: false, keySignature: 'C' 
            };
            audio = { context: null, lookahead: 25.0, scheduleAheadTime: 0.1, nextNoteTime: 0.0, pauseStartTime: 0.0 };
            notesData = {
                all: ['C/1','C#/1','Db/1','D/1','D#/1','Eb/1','E/1','F/1','F#/1','Gb/1','G/1','G#/1','Ab/1','A/1','A#/1','Bb/1','B/1','C/2','C#/2','Db/2','D/2','D#/2','Eb/2','E/2','F/2','F#/2','Gb/2','G/2','G#/2','Ab/2','A/2','A#/2','Bb/2','B/2','C/3','C#/3','Db/3','D/3','D#/3','Eb/3','E/3','F/3','F#/3','Gb/3','G/3','G#/3','Ab/3','A/3','A#/3','Bb/3','B/3','C/4','C#/4','Db/4','D/4','D#/4','Eb/4','E/4','F/4','F#/4','Gb/4','G/4','G#/4','Ab/4','A/4','A#/4','Bb/4','B/4','C/5','C#/5','Db/5','D/5','D#/5','Eb/5','E/5','F/5','F#/5','Gb/5','G/5','G#/5','Ab/5','A/5','A#/5','Bb/5','B/5','C/6','C#/6','Db/6','D/6','D#/6','Eb/6','E/6'],
                natural: [], noteToLatin: {'C':'Do','D':'Re','E':'Mi','F':'Fa','G':'Sol','A':'La','B':'Si'},
                letterToDiatonic: {'C':0,'D':1,'E':2,'F':3,'G':4,'A':5,'B':6}, clefs: {},
                triadFormulas: { 'all': ["2-4", "2-5", "3-5", "1-4", "3-6", "3-4"], 'triad_fundamental': ["2-4"], 'triad_inv1': ["2-5"], 'triad_inv2': ["3-5"], 'sus2_all': ["1-4", "3-6"], 'sus4_all': ["3-4", "1-4"] },
                voicingsByDifficulty: {
                    medium: { 'drop2': 'Drop 2', 'drop3': 'Drop 3' },
                    advanced: { 'drop2': 'Drop 2', 'drop3': 'Drop 3', 'drop24': 'Drop 2 & 4', 'drop23': 'Drop 2 & 3', 'doubleDrop23': 'Double Drop 2 & 3' }
                },
                keySignatures: {
                    'C': { type: null, count: 0, notes: ['C','D','E','F','G','A','B'] },
                    'G': { type: 'sharp', count: 1, notes: ['G','A','B','C','D','E','F#'] },
                    'D': { type: 'sharp', count: 2, notes: ['D','E','F#','G','A','B','C#'] },
                    'A': { type: 'sharp', count: 3, notes: ['A','B','C#','D','E','F#','G#'] },
                    'E': { type: 'sharp', count: 4, notes: ['E','F#','G#','A','B','C#','D#'] },
                    'B': { type: 'sharp', count: 5, notes: ['B','C#','D#','E','F#','G#','A#'] },
                    'F#': { type: 'sharp', count: 6, notes: ['F#','G#','A#','B','C#','D#','E#'] },
                    'C#': { type: 'sharp', count: 7, notes: ['C#','D#','E#','F#','G#','A#','B#'] },
                    'F': { type: 'flat', count: 1, notes: ['F','G','A','Bb','C','D','E'] },
                    'Bb': { type: 'flat', count: 2, notes: ['Bb','C','D','Eb','F','G','A'] },
                    'Eb': { type: 'flat', count: 3, notes: ['Eb','F','G','Ab','Bb','C','D'] },
                    'Ab': { type: 'flat', count: 4, notes: ['Ab','Bb','C','Db','Eb','F','G'] },
                    'Db': { type: 'flat', count: 5, notes: ['Db','Eb','F','Gb','Ab','Bb','C'] },
                    'Gb': { type: 'flat', count: 6, notes: ['Gb','Ab','Bb','Cb','Db','Eb','F'] },
                    'Cb': { type: 'flat', count: 7, notes: ['Cb','Db','Eb','Fb','Gb','Ab','Bb'] }
                },
                sharpPositions: { 'G': [40, 55, 35, 50, 65, 45, 60], 'F': [50, 65, 45, 60, 75, 55, 70], 'C': [45, 60, 40, 55, 70, 50, 65] },
                flatPositions: { 'G': [55, 40, 60, 45, 65, 50, 70], 'F': [65, 50, 70, 55, 75, 60, 80], 'C': [60, 45, 65, 50, 70, 55, 75] },
                chromaticMap: {},
                noteNames: ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B']
            };
            notesData.natural = notesData.all.filter(n => !n.includes('#') && !n.includes('b'));
            const calculateDiatonic = (note) => { const parts = note.split('/'); const letter = parts[0][0]; const octave = parseInt(parts[1], 10); return octave * 7 + notesData.letterToDiatonic[letter]; };
            const generateY = (baseNote) => { const baseVal = calculateDiatonic(baseNote); const positions = {}; notesData.all.forEach(n => { positions[n] = 80 - (calculateDiatonic(n) - baseVal) * 5; }); return positions; };
            notesData.clefs = { 'G': { symbol: '𝄞', symbolY: 75, yPositions: generateY('E/4') }, 'F': { symbol: '𝄢', symbolY: 75, yPositions: generateY('G/2') }, 'C': { symbol: '𝄡', symbolY: 80, yPositions: generateY('F/3') } };
            notesData.all.forEach(note => {
                const [name, octaveStr] = note.split('/');
                const octave = parseInt(octaveStr, 10);
                let value;
                if(name.includes('#')) value = notesData.noteNames.indexOf(name);
                else if (name.includes('b')) value = 'C Db D Eb E F Gb G Ab A Bb B'.split(' ').indexOf(name);
                else value = notesData.noteNames.indexOf(name);
                notesData.chromaticMap[note] = 12 * octave + value;
            });
        }
        function attachEventListeners() {
            ui.startStopButton.addEventListener('click', () => state.exerciseStarted ? stopExercise() : startExercise());
            ui.pauseResumeButton.addEventListener('click', togglePause);
            ui.showTutorialBtn.addEventListener('click', showTutorial);
            ui.closeModalBtn.addEventListener('click', hideTutorial);
            ui.tutorialModal.addEventListener('click', (e) => e.target === ui.tutorialModal && hideTutorial());
            ui.nextTutorialStepBtn.addEventListener('click', nextTutorialStep);
            ui.showNoteNamesToggle.addEventListener('change', () => { state.showNoteNames = ui.showNoteNamesToggle.checked; renderStave(); });
            ui.exerciseTypeRadios.forEach(radio => radio.addEventListener('change', (e) => {
                state.exerciseType = e.target.value;
                updateHarmonyControlsVisibility();
                if(state.exerciseStarted) stopExercise();
                renderStave();
            }));
            ui.notesPerChordSelect.addEventListener('change', (e) => { 
                state.notesPerChord = parseInt(e.target.value, 10); 
                updateHarmonyControlsVisibility();
                if(state.exerciseStarted) stopExercise();
                renderStave(); 
            });
            ui.intervalSelect.addEventListener('change', e => { state.selectedInterval = parseInt(e.target.value, 10); if(state.exerciseStarted) stopExercise(); });
            ui.triadSelect.addEventListener('change', e => { state.selectedTriad = e.target.value; if(state.exerciseStarted) stopExercise(); });
            ui.quadVoicingSelect.addEventListener('change', e => { state.selectedQuadVoicing = e.target.value; if(state.exerciseStarted) stopExercise(); });
            
            ui.measuresSelect.addEventListener('change', handleMeasuresChange);
            ui.customMeasuresInput.addEventListener('input', handleMeasuresChange);
            
            ui.difficultySelect.addEventListener('change', () => {
                updateHarmonyControlsVisibility();
                updateDropVoicingOptions();
                if (state.exerciseStarted) stopExercise();
                renderStave();
            });

            [ui.clefSelect, ui.timeSigSelect, ui.changeBeatSelect, ui.keySigSelect].forEach(el => {
                el.addEventListener('change', () => {
                    if (state.exerciseStarted) stopExercise();
                    if (el === ui.timeSigSelect) updateChangeBeatOptions();
                    if (el === ui.keySigSelect) state.keySignature = ui.keySigSelect.value;
                    state.measuresChangeBeat = parseInt(ui.changeBeatSelect.value, 10);
                    renderStave();
                });
            });
        }
        function updateHarmonyControlsVisibility() {
            const isHarmony = state.exerciseType === 'armonia';
            const notes = parseInt(ui.notesPerChordSelect.value, 10);
            ui.harmonyOptionsContainer.classList.toggle('hidden', !isHarmony);
            
            ui.intervalOptionsContainer.classList.toggle('hidden', !isHarmony || notes !== 2);
            ui.triadOptionsContainer.classList.toggle('hidden', !isHarmony || notes !== 3);
            ui.quadOptionsContainer.classList.toggle('hidden', !isHarmony || notes !== 4);
            
            const isQuad = isHarmony && notes === 4;
            const basicOption = ui.difficultySelect.querySelector('option[value="basico"]');
            if (basicOption) basicOption.disabled = isQuad;
            
            if (isQuad && ui.difficultySelect.value === 'basico') {
                ui.difficultySelect.value = 'medium';
                ui.difficultySelect.dispatchEvent(new Event('change'));
            }
        }
        function updateDropVoicingOptions() {
            const difficulty = ui.difficultySelect.value;
            const effectiveDifficulty = (difficulty === 'basico' && state.notesPerChord === 4) ? 'medium' : difficulty;

            const voicings = notesData.voicingsByDifficulty[effectiveDifficulty];
            if (!voicings) {
                ui.quadVoicingSelect.innerHTML = '';
                return;
            }

            const currentVoicing = ui.quadVoicingSelect.value;
            ui.quadVoicingSelect.innerHTML = '';
            let newSelectionAvailable = false;
            
            for (const key in voicings) {
                const option = document.createElement('option');
                option.value = key;
                option.textContent = voicings[key];
                ui.quadVoicingSelect.appendChild(option);
                if (key === currentVoicing) newSelectionAvailable = true;
            }
            
            if (newSelectionAvailable) {
                ui.quadVoicingSelect.value = currentVoicing;
            } else {
                ui.quadVoicingSelect.selectedIndex = 0;
            }
        }

        function handleMeasuresChange() {
            if (ui.measuresSelect.value === 'custom') {
                ui.customMeasuresContainer.classList.remove('hidden');
                const customValue = parseInt(ui.customMeasuresInput.value, 10);
                state.measuresPerExercise = isNaN(customValue) || customValue <= 0 ? 1 : customValue;
            } else {
                ui.customMeasuresContainer.classList.add('hidden');
                state.measuresPerExercise = parseInt(ui.measuresSelect.value, 10);
            }
            ui.measuresCount.textContent = `0 / ${state.measuresPerExercise}`;
        }
        function updateChangeBeatOptions() {
            const timeSigParts = ui.timeSigSelect.value.split('/');
            state.timeSignatureBeats = parseInt(timeSigParts[0], 10);
            ui.changeBeatSelect.innerHTML = '';
            for (let i = 1; i <= state.timeSignatureBeats; i++) {
                const option = document.createElement('option');
                option.value = i; option.textContent = i;
                ui.changeBeatSelect.appendChild(option);
            }
            ui.changeBeatSelect.value = state.timeSignatureBeats;
            state.measuresChangeBeat = state.timeSignatureBeats;
        }
        async function startExercise() {
            try {
                if (!audio.context) audio.context = new (window.AudioContext || window.webkitAudioContext)();
                if (audio.context.state === 'suspended') await audio.context.resume();
                handleMeasuresChange();
                state.exerciseMeasures = generateExercise();
                if (state.exerciseMeasures.length === 0) { console.error("Failed to generate measures."); stopExercise(); return; }
                Object.assign(state, { exerciseStarted: true, isPlaying: true, isPaused: false, isPreRoll: true, currentMetronomeCount: 0 });
                ui.preRollMessage.classList.remove('hidden');
                ui.displayArea.classList.add('hidden');
                ui.startStopButton.textContent = 'Detener';
                ui.pauseResumeButton.textContent = 'Pausar';
                ui.pauseResumeButton.classList.remove('hidden');
                audio.nextNoteTime = audio.context.currentTime + 0.5;
                scheduler();
                renderStave();
            } catch (e) { console.error("Error starting exercise:", e); stopExercise(); }
        }
        function stopExercise() {
            Object.assign(state, { exerciseStarted: false, isPlaying: false, isPaused: false, isPreRoll: false, currentMeasureIndex: -1, currentMetronomeCount: 0, currentMeasureContent: [] });
            ui.startStopButton.textContent = 'Comenzar';
            ui.pauseResumeButton.classList.add('hidden');
            ui.displayArea.classList.add('hidden');
            if (state.metronomeTimer) { clearTimeout(state.metronomeTimer); state.metronomeTimer = null; }
            handleMeasuresChange();
            ui.metronomeCount.textContent = "0";
            ui.preRollMessage.classList.add('hidden');
            renderStave();
        }
        function togglePause() {
            if (!state.exerciseStarted) return;
            state.isPaused = !state.isPaused;
            if (state.isPaused) {
                clearTimeout(state.metronomeTimer);
                audio.pauseStartTime = audio.context.currentTime;
                ui.pauseResumeButton.textContent = 'Reanudar';
            } else {
                const elapsedPauseTime = audio.context.currentTime - audio.pauseStartTime;
                audio.nextNoteTime += elapsedPauseTime;
                ui.pauseResumeButton.textContent = 'Pausar';
                scheduler();
            }
        }
        function scheduler() {
            if (!state.isPlaying || state.isPaused) return;
            while (audio.nextNoteTime < audio.context.currentTime + audio.scheduleAheadTime) {
                const tempo = parseInt(ui.tempoInput.value, 10);
                const beatDuration = 60.0 / tempo;
                state.currentMetronomeCount++;
                if (state.currentMetronomeCount > state.timeSignatureBeats) state.currentMetronomeCount = 1;
                playMetronomeSound(audio.nextNoteTime, state.currentMetronomeCount === 1);
                if (state.isPreRoll) {
                    ui.preRollCount.textContent = state.currentMetronomeCount;
                    if (state.currentMetronomeCount === state.timeSignatureBeats) {
                        state.isPreRoll = false;
                        ui.preRollMessage.classList.add('hidden');
                        ui.displayArea.classList.remove('hidden');
                        state.currentMeasureIndex = 0;
                        state.currentMeasureContent = state.exerciseMeasures[0];
                        ui.measuresCount.textContent = `1 / ${state.measuresPerExercise}`;
                    }
                } else {
                    if (state.currentMetronomeCount === state.measuresChangeBeat) {
                        state.currentMeasureIndex++;
                        if (state.currentMeasureIndex < state.measuresPerExercise) {
                            state.currentMeasureContent = state.exerciseMeasures[state.currentMeasureIndex];
                            ui.measuresCount.textContent = `${state.currentMeasureIndex + 1} / ${state.measuresPerExercise}`;
                        } else { stopExercise(); return; }
                    }
                    ui.metronomeCount.textContent = state.currentMetronomeCount;
                }
                renderStave();
                audio.nextNoteTime += beatDuration;
            }
            state.metronomeTimer = setTimeout(scheduler, audio.lookahead);
        }
        function getNoteRangeForDifficulty() {
            const { natural } = notesData;
            switch (ui.difficultySelect.value) {
                 case 'basico': 
                    if (ui.clefSelect.value === 'G') return natural.slice(natural.indexOf('E/4'), natural.indexOf('F/5') + 1);
                    if (ui.clefSelect.value === 'F') return natural.slice(natural.indexOf('G/2'), natural.indexOf('A/3') + 1);
                    return natural.slice(natural.indexOf('F/3'), natural.indexOf('G/4') + 1);
                case 'medium':
                    if (ui.clefSelect.value === 'G') return natural.slice(natural.indexOf('E/3'), natural.indexOf('A/5') + 1);
                    if (ui.clefSelect.value === 'F') return natural.slice(natural.indexOf('E/2'), natural.indexOf('C/4') + 1);
                    return natural.slice(natural.indexOf('D/2'), natural.indexOf('B/4') + 1);
                default:
                    if (ui.clefSelect.value === 'G') return natural.slice(natural.indexOf('E/3'), natural.indexOf('E/6') + 1);
                    if (ui.clefSelect.value === 'F') return natural.slice(natural.indexOf('C/2'), natural.indexOf('F/4') + 1);
                    return natural.slice(natural.indexOf('B/1'), natural.indexOf('B/4') + 1);
            }
        }
        function generateExercise() {
            const difficultyBoundaries = getNoteRangeForDifficulty();
            const noteRange = notesData.all.slice(
                notesData.all.indexOf(difficultyBoundaries[0]),
                notesData.all.indexOf(difficultyBoundaries[difficultyBoundaries.length - 1]) + 1
            );
            
            const diatonicScale = notesData.keySignatures[state.keySignature].notes;
            const fullDiatonicPool = [];
            for (let octave = 1; octave < 7; octave++) {
                for (const noteName of diatonicScale) {
                    const noteWithOctave = `${noteName}/${octave}`;
                    if (notesData.all.includes(noteWithOctave)) fullDiatonicPool.push(noteWithOctave);
                }
            }
            const diatonicNotePool = fullDiatonicPool.filter(note => noteRange.includes(note));

            if (!diatonicNotePool || diatonicNotePool.length < 2) { console.error("Diatonic note pool too small.", diatonicNotePool); return []; }
            
            const allMeasures = [];
            let lastNote = diatonicNotePool[Math.floor(Math.random() * diatonicNotePool.length)];
            
            for (let i = 0; i < state.measuresPerExercise; i++) {
                let firstNoteInMeasure = (i === 0) ? lastNote : getNextMeasureStartNote(lastNote, diatonicNotePool);
                let rootNotesForMeasure = [firstNoteInMeasure];
                
                const maxInterval = (ui.difficultySelect.value === 'advanced') ? 7 : 5;
                const firstNoteIndex = diatonicNotePool.indexOf(firstNoteInMeasure);
                const measureNotePool = diatonicNotePool.slice(
                    Math.max(0, firstNoteIndex - maxInterval),
                    Math.min(diatonicNotePool.length - 1, firstNoteIndex + maxInterval) + 1
                );

                for (let b = 1; b < state.timeSignatureBeats; b++) {
                    const nextRoot = getNextMelodicNote(rootNotesForMeasure, measureNotePool.length > 1 ? measureNotePool : diatonicNotePool);
                    rootNotesForMeasure.push(nextRoot);
                }

                if (state.exerciseType === 'melodia') {
                    allMeasures.push(rootNotesForMeasure);
                } else {
                    const measureChords = rootNotesForMeasure.map(root => generateHarmonicItem(root, noteRange, fullDiatonicPool)).filter(Boolean);
                    if (measureChords.length === state.timeSignatureBeats) {
                        allMeasures.push(measureChords);
                    } else { i--; continue; }
                }

                if(allMeasures.length > i && allMeasures[i] && allMeasures[i].length > 0) {
                     const lastItem = allMeasures[i][allMeasures[i].length - 1];
                     lastNote = Array.isArray(lastItem) ? (lastItem[0].split('/')[0].length > 1 ? lastItem[0] : lastItem.sort((a,b) => notesData.all.indexOf(a) - notesData.all.indexOf(b))[0] ) : lastItem;
                }
            }
            return allMeasures;
        }
        function getNextMeasureStartNote(previousNote, notePool) {
            const lastNoteIndex = notePool.indexOf(previousNote);
            const maxLeap = (ui.difficultySelect.value === 'advanced') ? 7 : 4; 
            let possibleNotes = [];
            for (let leap = 3; leap <= maxLeap; leap++) {
                if (lastNoteIndex + leap < notePool.length) possibleNotes.push(notePool[lastNoteIndex + leap]);
                if (lastNoteIndex - leap >= 0) possibleNotes.push(notePool[lastNoteIndex - leap]);
            }
            return possibleNotes.length > 0 ? possibleNotes[Math.floor(Math.random() * possibleNotes.length)] : previousNote;
        }
        function getNextMelodicNote(currentNotes, notePool) {
            const previousNote = currentNotes[currentNotes.length - 1];
            const prevNoteIndex = notePool.indexOf(previousNote);
            let direction = 0;
            if (currentNotes.length > 1) {
                const lastInterval = notePool.indexOf(previousNote) - notePool.indexOf(currentNotes[currentNotes.length - 2]);
                if (Math.abs(lastInterval) >= 3) direction = lastInterval > 0 ? -1 : 1;
            }
            let candidates;
            if (direction !== 0) {
                 candidates = notePool.filter(n => {
                    const interval = notePool.indexOf(n) - prevNoteIndex;
                    return (direction === 1 && interval > 0 && interval <= 2) || (direction === -1 && interval < 0 && interval >= -2);
                });
            } else {
                candidates = notePool.filter(n => Math.abs(notePool.indexOf(n) - prevNoteIndex) <= 2 && n !== previousNote);
            }
            if (candidates.length === 0) candidates = notePool.filter(n => n !== previousNote);
            if (candidates.length === 0) return previousNote;
            return candidates[Math.floor(Math.random() * candidates.length)];
        }
        function alterNote(note, semitones) {
            const index = notesData.all.indexOf(note);
            if (index === -1) return null;
            const newIndex = index + semitones;
            return (newIndex >= 0 && newIndex < notesData.all.length) ? notesData.all[newIndex] : null;
        }
        
        function generateHarmonicItem(rootNote, noteRange, fullDiatonicPool) {
            let item = null;
            let attempts = 0;
            const numNotes = state.notesPerChord;

            while (item === null && attempts < 50) {
                attempts++;
                const currentRoot = attempts > 1 ? noteRange[Math.floor(Math.random() * noteRange.length)] : rootNote;
                const rootIndex = fullDiatonicPool.indexOf(currentRoot);

                if (rootIndex === -1) continue;
                
                let closePositionNotes = [];

                if (numNotes === 2) {
                    let intervalSteps = state.selectedInterval;
                    if (intervalSteps === 0) intervalSteps = [1, 2, 3, 4, 5, 6, 7][Math.floor(Math.random() * 7)];
                    const topNoteIndex = rootIndex + intervalSteps;
                    if (topNoteIndex < fullDiatonicPool.length) {
                        closePositionNotes = [currentRoot, fullDiatonicPool[topNoteIndex]];
                    }
                } else if (numNotes === 3) {
                    const formulaKey = state.selectedTriad;
                    const formulas = notesData.triadFormulas[formulaKey];
                    const formula = formulas[Math.floor(Math.random() * formulas.length)];
                    const intervals = formula.split('-').map(Number);
                    if ((rootIndex + intervals[1]) < fullDiatonicPool.length) {
                        const note1 = fullDiatonicPool[rootIndex + intervals[0]];
                        const note2 = fullDiatonicPool[rootIndex + intervals[1]];
                        closePositionNotes = [currentRoot, note1, note2];
                    }
                } else if (numNotes === 4) {
                    if (rootIndex + 6 < fullDiatonicPool.length) {
                        closePositionNotes = [
                            fullDiatonicPool[rootIndex],
                            fullDiatonicPool[rootIndex + 2],
                            fullDiatonicPool[rootIndex + 4],
                            fullDiatonicPool[rootIndex + 6]
                        ];
                    }
                }

                if (closePositionNotes.length !== numNotes) continue;

                if (numNotes < 4) {
                    if (closePositionNotes.every(n => noteRange.includes(n))) {
                        item = closePositionNotes;
                    }
                } else { 
                    let voicing = ui.quadVoicingSelect.value;
                    let inversion = Math.floor(Math.random() * 4);
                    
                    let invertedNotes = [...closePositionNotes];
                    for (let i = 0; i < inversion; i++) {
                        invertedNotes.push(alterNote(invertedNotes.shift(), 12));
                    }
                    invertedNotes = invertedNotes.filter(Boolean).sort((a, b) => notesData.all.indexOf(a) - notesData.all.indexOf(b));
                    if (invertedNotes.length < 4) continue;

                    let voicedChord = [...invertedNotes];
                    const dropNote = (note, octavesDown) => alterNote(note, -12 * octavesDown);
                    
                    try {
                        if (voicing === 'drop2') voicedChord.unshift(dropNote(voicedChord.splice(2, 1)[0], 1));
                        else if (voicing === 'drop3') voicedChord.unshift(dropNote(voicedChord.splice(1, 1)[0], 1));
                        else if (voicing === 'drop24') {
                            let note2 = dropNote(voicedChord.splice(2, 1)[0], 1); let note4 = dropNote(voicedChord.splice(0, 1)[0], 1);
                            voicedChord.unshift(note2, note4);
                        } else if (voicing === 'drop23') {
                            let note2 = dropNote(voicedChord.splice(2, 1)[0], 1); let note3 = dropNote(voicedChord.splice(1, 1)[0], 1);
                            voicedChord.unshift(note2, note3);
                        } else if (voicing === 'doubleDrop23') {
                            let note2 = dropNote(voicedChord.splice(2, 1)[0], 2); let note3 = dropNote(voicedChord.splice(1, 1)[0], 1);
                            voicedChord.unshift(note2, note3);
                        }
                    } catch (e) { voicedChord = []; }
                    
                    voicedChord = voicedChord.filter(Boolean);
                    if (voicedChord.length === 4 && voicedChord.every(n => noteRange.includes(n))) {
                        item = voicedChord;
                    }
                }
            }
            return item;
        }
        function playMetronomeSound(time, isAccent) {
            if (!audio.context) return;
            const osc = audio.context.createOscillator(); const gain = audio.context.createGain();
            osc.connect(gain); gain.connect(audio.context.destination);
            osc.frequency.value = isAccent ? 880 : 440; osc.type = 'square';
            gain.gain.setValueAtTime(isAccent ? 0.3 : 0.2, time);
            osc.start(time); gain.gain.exponentialRampToValueAtTime(0.001, time + 0.05); osc.stop(time + 0.1);
        }
        function renderStave() {
            ui.staveContainer.innerHTML = '';
            const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
            svg.setAttribute('viewBox', `-10 0 380 200`);
            ui.staveContainer.appendChild(svg);
            let contentToDraw = [];
            if (state.isPreRoll && state.exerciseMeasures.length > 0) contentToDraw = state.exerciseMeasures[0];
            else if (state.exerciseStarted) contentToDraw = state.currentMeasureContent;
            drawMeasure(svg, contentToDraw, 30, 300);
        }
        function drawMeasure(svg, content, xOffset, measureWidth) {
            const clefInfo = notesData.clefs[ui.clefSelect.value];
            const group = document.createElementNS("http://www.w3.org/2000/svg", "g");
            svg.appendChild(group);
            for (let i = 0; i < 5; i++) {
                const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
                line.setAttribute('x1', xOffset); line.setAttribute('y1', 40 + i * 10);
                line.setAttribute('x2', xOffset + measureWidth); line.setAttribute('y2', 40 + i * 10);
                line.setAttribute('stroke', '#000'); line.setAttribute('stroke-width', '1');
                group.appendChild(line);
            }
            let currentX = xOffset + 20;
            const clef = document.createElementNS("http://www.w3.org/2000/svg", "text");
            clef.setAttribute('x', currentX); clef.setAttribute('y', clefInfo.symbolY);
            clef.setAttribute('font-size', '40px'); clef.textContent = clefInfo.symbol;
            group.appendChild(clef); currentX += 30;

            const keyInfo = notesData.keySignatures[state.keySignature];
            const currentClef = ui.clefSelect.value;
            if (keyInfo && keyInfo.count > 0) {
                const positions = keyInfo.type === 'sharp' ? notesData.sharpPositions[currentClef] : notesData.flatPositions[currentClef];
                const symbol = keyInfo.type === 'sharp' ? '♯' : '♭';
                const fontSize = keyInfo.type === 'sharp' ? '22px' : '24px';
                for (let i = 0; i < keyInfo.count; i++) {
                    const accidental = document.createElementNS("http://www.w3.org/2000/svg", "text");
                    accidental.setAttribute('x', currentX);
                    accidental.setAttribute('y', positions[i]);
                    accidental.setAttribute('font-size', fontSize);
                    accidental.setAttribute('dominant-baseline', 'middle');
                    accidental.textContent = symbol;
                    group.appendChild(accidental);
                    currentX += (keyInfo.type === 'sharp' ? 8 : 9);
                }
                currentX += 15; 
            }

            const timeSigParts = ui.timeSigSelect.value.split('/');
            const timeSigTop = document.createElementNS("http://www.w3.org/2000/svg", "text");
            timeSigTop.setAttribute('x', currentX); timeSigTop.setAttribute('y', 60);
            timeSigTop.setAttribute('font-size', '18px'); timeSigTop.textContent = timeSigParts[0];
            group.appendChild(timeSigTop);
            const timeSigBottom = document.createElementNS("http://www.w3.org/2000/svg", "text");
            timeSigBottom.setAttribute('x', currentX); timeSigBottom.setAttribute('y', 75);
            timeSigBottom.setAttribute('font-size', '18px'); timeSigBottom.textContent = timeSigParts[1];
            group.appendChild(timeSigBottom); currentX += 30;
            if(!content || content.length === 0) return;
            const noteSpacing = (measureWidth - (currentX - xOffset) - 20) / content.length;
            const noteStartX = currentX + noteSpacing / 2;
            content.forEach((item, index) => {
                if (!item || item.length === 0) return;
                const isChord = Array.isArray(item);
                const notes = isChord ? item.sort((a,b) => notesData.all.indexOf(b) - notesData.all.indexOf(a)) : [item];
                const itemX = noteStartX + index * noteSpacing;
                let noteObjects = notes.map(note => ({ note, y: clefInfo.yPositions[note] })).filter(n => n.y !== undefined);
                if (noteObjects.length !== notes.length) { console.warn("Undefined note Y position", notes); return; }
                let lastY = -1000;
                
                noteObjects.forEach(({note, y}) => {
                    let headX = itemX;
                    if(isChord && Math.abs(y - lastY) <= 5) {
                        headX = itemX + 12;
                    }
                    
                    const noteHead = document.createElementNS("http://www.w3.org/2000/svg", "ellipse");
                    noteHead.setAttribute('cx', headX); noteHead.setAttribute('cy', y);
                    noteHead.setAttribute('rx', '6'); noteHead.setAttribute('ry', '4.5');
                    noteHead.setAttribute('transform', `rotate(-15, ${headX}, ${y})`);
                    noteHead.setAttribute('fill', '#000');
                    group.appendChild(noteHead); lastY = y;
                    for(let ly = 40; ly >= y; ly -= 10) if(ly < 40) drawLedgerLine(group, headX, ly);
                    for(let ly = 80; ly <= y; ly += 10) if(ly > 80) drawLedgerLine(group, headX, ly);
                    if (state.showNoteNames) {
                        const noteNameText = document.createElementNS("http://www.w3.org/2000/svg", "text");
                        const noteCipher = note.split('/')[0], baseNote = noteCipher[0], accidental = noteCipher.slice(1);
                        noteNameText.textContent = notesData.noteToLatin[baseNote] + accidental;
                        noteNameText.setAttribute('x', headX); noteNameText.setAttribute('y', y + 20);
                        noteNameText.setAttribute('font-size', '12px');
                        noteNameText.setAttribute('fill', 'black');
                        noteNameText.setAttribute('text-anchor', 'middle');
                        group.appendChild(noteNameText);
                    }
                });
            });
        }
                function drawLedgerLine(parent, x, y){
            const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
            line.setAttribute('x1', x - 10); line.setAttribute('y1', y);
            line.setAttribute('x2', x + 10); line.setAttribute('y2', y);
            line.setAttribute('stroke', 'black'); line.setAttribute('stroke-width', '1');
            parent.appendChild(line);
        }
        // --- TUTORIAL FUNCTIONS ---
        const tutorialSteps = [
            { id: 'exercise-type-control', text: 'Aquí puedes elegir entre ejercicios de Melodía (una nota a la vez) o Armonía (varias notas juntas, o acordes).' },
            { id: 'controls-container', text: 'En esta sección, puedes ajustar todos los parámetros del ejercicio: tempo, clave, compás, nivel de dificultad y más.' },
            { id: 'key-signature-select', text: 'Elige una armadura de clave para practicar con sostenidos o bemoles.'},
            { id: 'quad-options-container', text: 'Para acordes de 4 notas, aquí defines el voicing (Drop 2). La calidad y la inversión serán aleatorias.'},
            { id: 'startStopButton', text: 'Usa este botón para comenzar o detener el ejercicio en cualquier momento.' },
            { id: 'stave-container', text: 'El pentagrama mostrará las notas que debes leer. ¡Prepárate!' },
            { id: 'displayArea', text: 'Aquí verás el conteo del metrónomo y el progreso de los compases durante el ejercicio.' }
        ];
        let currentTutorialStep = 0;
        function showTutorial() {
            currentTutorialStep = 0;
            ui.tutorialModal.classList.remove('hidden');
            updateTutorialStep();
        }
        function hideTutorial() {
            ui.tutorialModal.classList.add('hidden');
            ui.tutorialHighlight.classList.add('hidden');
        }
        function nextTutorialStep() {
            currentTutorialStep++;
            if (currentTutorialStep >= tutorialSteps.length) {
                hideTutorial();
            } else {
                updateTutorialStep();
            }
        }
        function updateTutorialStep() {
            const step = tutorialSteps[currentTutorialStep];
            ui.tutorialStepsContainer.innerHTML = `<p class="tutorial-step active">${currentTutorialStep + 1}. ${step.text}</p>`;
            
            const targetElement = document.getElementById(step.id);
            if (targetElement) {
                const rect = targetElement.getBoundingClientRect();
                const highlight = ui.tutorialHighlight;
                highlight.style.left = `${rect.left - 10}px`;
                highlight.style.top = `${rect.top - 10}px`;
                highlight.style.width = `${rect.width + 20}px`;
                highlight.style.height = `${rect.height + 20}px`;
                highlight.style.boxShadow = '0 0 0 9999px rgba(0, 0, 0, 0.7)';
                highlight.classList.remove('hidden');
            }
        }
    </script>
</body>
</html>


